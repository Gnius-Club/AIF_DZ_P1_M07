<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Constructores de la Galaxia: Misi√≥n a Contrarreloj</title>

<style>
  /* ------------------------------
     ESTILOS GENERALES / ACCESIBILIDAD
     ------------------------------ */
  :root{
    --bg:#0b0f1a;
    --panel:#121a2b;
    --panel-2:#0f1630;
    --accent:#22d3ee;   /* cian brillante alto contraste */
    --accent-2:#f59e0b; /* dorado */
    --ok:#10b981;
    --warn:#ef4444;
    --text:#e5e7eb;     /* gris muy claro */
    --muted:#93c5fd;
    --shadow: 0 10px 24px rgba(0,0,0,.3), inset 0 0 0 1px rgba(255,255,255,.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    background: radial-gradient(1200px 600px at 10% -10%, #18213d 0%, #0b0f1a 40%) fixed,
               radial-gradient(1200px 600px at 110% 110%, #0a1228 0%, #0b0f1a 40%) fixed;
  }
  button{
    background:linear-gradient(180deg, #21c8e5, #0ea5b7);
    color:#001018;
    border:none;
    border-radius:14px;
    padding:12px 18px;
    font-weight:700;
    font-size:16px;
    cursor:pointer;
    box-shadow:var(--shadow);
    transition: transform .06s ease, filter .2s ease;
  }
  button:hover{ transform: translateY(-1px); filter:brightness(1.05) }
  button:active{ transform: translateY(0) scale(.98) }

  .btn-ghost{ background:#22324f; color:var(--text) }
  .btn-warn { background: linear-gradient(180deg, #f59e0b, #e8790a); color:#1b1000 }
  .btn-mute { background:#233047 }

  .wrap{
    max-width:1200px;
    margin:0 auto;
    padding:24px;
  }

  .hidden{ display:none !important }
  .sr-only{
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0
  }

  /* ------------------------------
     PANTALLA: HANGAR / BRIEFING
     ------------------------------ */
  #screen-briefing{
    min-height:100vh;
    display:grid;
    place-items:center;
  }
  .briefing-card{
    width:min(980px, 95vw);
    background: linear-gradient(180deg, #10172b, #0c1326);
    border:1px solid rgba(255,255,255,.07);
    border-radius:20px;
    padding:24px;
    box-shadow: var(--shadow);
  }
  .briefing-top{
    display:flex; gap:18px; align-items:center; margin-bottom:14px;
  }
  .avatar-chief{
    width:86px;height:86px;border-radius:18px;background:#1f2a44;display:grid;place-items:center;
    box-shadow: inset 0 0 0 2px rgba(34,211,238,.4);
    font-size:46px;
  }
  .title{
    font-size: clamp(22px, 3vw, 34px);
    margin:0 0 6px 0; color:var(--accent)
  }
  .subtitle{ color:var(--muted) }

  .rules-grid{
    display:grid; grid-template-columns: repeat(3,1fr); gap:14px; margin:18px 0;
  }
  .rule{
    background:#0f1630; border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px;
    box-shadow:var(--shadow);
  }
  .rule h4{ margin:6px 0 8px 0; color:var(--accent-2)}
  .demo{
    display:flex; gap:8px; align-items:flex-start; font-size:14px;
  }
  .demo .ok, .demo .bad{
    flex:1; padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,.06);
  }
  .demo .ok{ background:rgba(16,185,129,.12); }
  .demo .bad{ background:rgba(239,68,68,.12); }

  .briefing-actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px }

  /* ------------------------------
     HUD DEL JUEGO (pantalla principal)
     ------------------------------ */
  #screen-game{ min-height:100vh }
  .hud{
    display:grid; grid-template-columns: 1.2fr .9fr .9fr; gap:16px;
  }
  .panel{
    background:linear-gradient(180deg, #121a2b, #0e1529);
    border:1px solid rgba(255,255,255,.07);
    border-radius:16px; padding:14px; box-shadow:var(--shadow);
  }

  /* Columna: NAVE */
  .ship-area{
    min-height:400px; position:relative; overflow:hidden;
    background:
      radial-gradient(200px 120px at 20% 10%, rgba(255,255,255,.07) 0, transparent 60%),
      radial-gradient(200px 120px at 80% 90%, rgba(255,255,255,.05) 0, transparent 60%);
  }
  .ship{
    width:100%; height:100%;
    display:grid; place-items:center;
  }
  .ship-svg{
    width:90%; max-width:520px; filter:drop-shadow(0 8px 24px rgba(0,0,0,.35));
  }
  .piece{
    transition: transform .5s ease, opacity .5s ease, filter .5s ease;
    opacity:.25; filter:grayscale(1)
  }
  .piece.active{ opacity:1; filter:none }
  .piece.placed{ opacity:1; filter:none; transform:translateY(0) scale(1) }

  .progress-steps{
    margin-top:10px; display:flex; gap:6px; flex-wrap:wrap;
  }
  .step-dot{
    width:18px; height:18px; border-radius:50%; background:#22324f; border:1px solid rgba(255,255,255,.1)
  }
  .step-dot.done{ background:var(--ok) }
  .step-dot.current{ outline:2px solid var(--accent); box-shadow:0 0 0 3px rgba(34,211,238,.25) }

  /* Columna: VIDEOLLAMADA */
  .call-grid{
    display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;
  }
  .call-window{
    position:relative;
    background:#0b1326 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="100"><defs><pattern id="g" patternUnits="userSpaceOnUse" width="14" height="14"><circle cx="1" cy="1" r="1" fill="%23ffffff22"/></pattern></defs><rect width="100%" height="100%" fill="%230b1326"/><rect width="100%" height="100%" fill="url(%23g)"/></svg>') center/auto;
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px; height:120px; display:grid; place-items:center; overflow:hidden;
    box-shadow:var(--shadow);
  }
  .name-tag{
    position:absolute; bottom:6px; left:6px; background:#0e1a30; padding:4px 8px; border-radius:10px; font-size:12px; border:1px solid rgba(255,255,255,.08)
  }
  .bubble{
    position:absolute; top:8px; right:8px; background:#0e1a30; padding:6px 8px; border-radius:10px; border:1px solid rgba(255,255,255,.08); font-size:12px
  }
  .storm{ position:absolute; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; font-size:34px }
  .storm.active{ display:flex }
  .rush{ animation: pulse .6s infinite alternate }
  @keyframes pulse{ from{ transform:scale(1)} to{ transform:scale(1.06)} }

  /* Columna: PLANO + CHAT + HERRAMIENTAS */
  .side{
    display:grid; grid-template-rows: auto auto 1fr; gap:10px;
  }
  .plan{
    min-height:120px; position:relative;
  }
  .plan-steps{ display:flex; gap:8px; flex-wrap:wrap; }
  .plan-step{
    background:#1b2745; border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:6px 8px; font-size:12px
  }
  .plan-overlay-block{
    position:absolute; inset:0; background:rgba(20,6,0,.75); display:none; align-items:center; justify-content:center; border:2px dashed #fecaca; border-radius:12px; text-align:center; padding:10px
  }
  .plan-overlay-block.active{ display:flex }

  .tools{
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .tool{
    font-size:28px; padding:8px 10px; border-radius:12px; border:2px solid rgba(255,255,255,.14);
    background:#15213c; cursor:grab; user-select:none
  }
  .tool:active{ cursor:grabbing; transform:scale(1.02) }
  .tool[draggable="true"]{ -webkit-user-drag: element; }

  .chat{
    min-height:130px; background:#0f172a; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; position:relative; overflow:hidden
  }
  .chat-messages{ max-height:100px; overflow:auto; font-size:13px; line-height:1.2 }
  .chat-flood{
    position:absolute; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; text-align:center; padding:10px; border: 2px dashed #eab308; border-radius:12px
  }
  .chat-flood.active{ display:flex }

  /* HUD superior */
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 16px 0
  }
  .timer{
    font-variant-numeric: tabular-nums;
    font-size:24px; font-weight:800; letter-spacing:.5px; color:#fff;
    background:#182444; border:1px solid rgba(255,255,255,.09); padding:8px 12px; border-radius:12px;
    box-shadow:var(--shadow)
  }
  .stars{ display:flex; gap:6px; font-size:24px }
  .controls{ display:flex; gap:8px; flex-wrap:wrap }

  /* ------------------------------
     PANTALLA: RESULTADO
     ------------------------------ */
  #screen-result{ min-height:100vh; display:grid; place-items:center; text-align:center }
  .result-card{
    width:min(720px, 94vw); background:linear-gradient(180deg, #0f1630, #0b1326); border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:20px; box-shadow:var(--shadow)
  }
  .metrics{ display:grid; grid-template-columns: repeat(2,1fr); gap:10px; margin:10px 0 18px 0; text-align:left }
  .metric{ background:#162243; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px }

  /* ------------------------------
     ANIMACIONES DE NAVE (victoria/derrota)
     ------------------------------ */
  .launch{
    animation: lift 2.4s ease forwards;
    transform-origin: 50% 100%;
  }
  @keyframes lift{
    0%{ transform: translateY(0) scale(1)}
    60%{ transform: translateY(-140px) scale(1.02)}
    100%{ transform: translateY(-300px) scale(1.05); opacity:0 }
  }
  .fail{
    animation: shake 1.1s ease both
  }
  @keyframes shake{
    0%,100%{ transform: translateX(0) }
    20%{ transform: translateX(-8px) }
    40%{ transform: translateX(8px) }
    60%{ transform: translateX(-6px) }
    80%{ transform: translateX(6px) }
  }

  /* RESPONSIVE */
  @media (max-width: 980px){
    .hud{ grid-template-columns: 1fr; }
    .call-grid{ grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<div class="wrap">

  <!-- ============================
       PANTALLA 1: HANGAR / BRIEFING
       ============================ -->
  <section id="screen-briefing" aria-labelledby="titulo-briefing">
    <div class="briefing-card" role="dialog" aria-modal="true" aria-label="Briefing de misi√≥n en el Hangar">
      <div class="briefing-top">
        <div class="avatar-chief" aria-hidden="true">üßë‚ÄçüöÄ</div>
        <div>
          <h1 id="titulo-briefing" class="title">Constructores de la Galaxia: <em>Misi√≥n a Contrarreloj</em></h1>
          <p class="subtitle">Tema: Ciudadan√≠a Digital ‚Äî Netiqueta en videollamadas y colaboraci√≥n en l√≠nea.</p>
        </div>
      </div>

      <!-- Presentaci√≥n de reglas con "voz en off" -->
      <p id="briefing-texto">
        Jefe de Misi√≥n: <strong>‚ÄúCadetes, hoy construir√°n una nave estelar respetando las normas de convivencia digital.‚Äù</strong>
      </p>

      <!-- Reglas -->
      <div class="rules-grid" aria-label="Reglas principales">
        <article class="rule" aria-labelledby="regla-plano">
          <h4 id="regla-plano">Regla del Plano</h4>
          <p>Seguir el orden indicado para que cada pieza encaje.</p>
          <div class="demo" aria-label="Ejemplos correctos e incorrectos">
            <div class="ok">‚úÖ Correcto: Colocar pieza <em>1</em> antes que la <em>2</em>.</div>
            <div class="bad">‚ùå Incorrecto: Saltar pasos; la gr√∫a tendr√° que retirarla y perder√°n tiempo.</div>
          </div>
        </article>
        <article class="rule" aria-labelledby="regla-escucha">
          <h4 id="regla-escucha">Regla de la Escucha</h4>
          <p>Hablar uno a la vez; respetar el turno del compa√±ero.</p>
          <div class="demo">
            <div class="ok">‚úÖ Correcto: Pides turno y esperas tu momento.</div>
            <div class="bad">‚ùå Incorrecto: Interrumpes y tomas el control sin permiso.</div>
          </div>
        </article>
        <article class="rule" aria-labelledby="regla-animo">
          <h4 id="regla-animo">Regla del √Ånimo</h4>
          <p>Si alguien se equivoca, lo apoyamos para que lo intente de nuevo.</p>
          <div class="demo">
            <div class="ok">‚úÖ Correcto: ‚Äú¬°T√∫ puedes! Probemos otra vez.‚Äù</div>
            <div class="bad">‚ùå Incorrecto: Burlas o reclamos que desaniman.</div>
          </div>
        </article>
      </div>

      <p><strong>Mensaje final:</strong> ‚ÄúTienen <strong>3 minutos</strong> para completar la nave. Cada error cuesta tiempo. ¬°Conf√≠o en ustedes!‚Äù</p>

      <div class="briefing-actions">
        <button id="btn-start" aria-label="Comenzar misi√≥n">¬°Comenzar Misi√≥n!</button>
        <button id="btn-briefing-voz" class="btn-ghost" aria-label="Reproducir narraci√≥n del briefing">üîä Narraci√≥n</button>
        <button id="btn-creditos" class="btn-ghost" aria-label="Ver cr√©ditos">Cr√©ditos</button>
      </div>
    </div>
  </section>

  <!-- ============================
       PANTALLA 2: JUEGO PRINCIPAL
       ============================ -->
  <section id="screen-game" class="hidden" aria-label="Vista principal de misi√≥n">
    <div class="topbar" role="toolbar" aria-label="Barra superior de control">
      <div class="stars" aria-label="Rango de estrellas"><span>‚≠ê</span><span>‚≠ê</span><span>‚≠ê</span></div>
      <div class="timer" aria-live="polite" id="timer">03:00</div>
      <div class="controls">
        <button id="btn-mute" class="btn-mute" aria-pressed="false" aria-label="Silenciar o activar sonido">üîà Sonido</button>
        <button id="btn-restart" class="btn-ghost" aria-label="Reiniciar misi√≥n">Reiniciar</button>
      </div>
    </div>

    <div class="hud">

      <!-- Columna 1: NAVE -->
      <section class="panel ship-area" aria-label="Nave parcialmente construida">
        <div class="ship">
          <!-- Nave como SVG simplificado con piezas -->
          <svg class="ship-svg" viewBox="0 0 300 300" role="img" aria-label="Nave espacial">
            <!-- cuerpo -->
            <g id="piece-1" class="piece">
              <ellipse cx="150" cy="170" rx="90" ry="50" fill="#1d4ed8"/>
              <rect x="75" y="160" width="150" height="20" fill="#1e40af"/>
            </g>
            <!-- cabina -->
            <g id="piece-2" class="piece">
              <ellipse cx="150" cy="130" rx="40" ry="28" fill="#22d3ee"/>
              <ellipse cx="150" cy="135" rx="26" ry="18" fill="#67e8f9"/>
            </g>
            <!-- aleta izquierda -->
            <g id="piece-3" class="piece">
              <polygon points="60,190 30,240 100,210" fill="#0ea5b7"/>
            </g>
            <!-- aleta derecha -->
            <g id="piece-4" class="piece">
              <polygon points="240,190 270,240 200,210" fill="#0ea5b7"/>
            </g>
            <!-- motor -->
            <g id="piece-5" class="piece">
              <rect x="135" y="220" width="30" height="40" fill="#334155"/>
              <polygon points="150,260 165,300 135,300" fill="#f59e0b"/>
            </g>
            <!-- emblema -->
            <g id="piece-6" class="piece">
              <circle cx="150" cy="170" r="14" fill="#f59e0b"/>
              <text x="150" y="174" text-anchor="middle" font-size="12" fill="#0b0f1a">GC</text>
            </g>
          </svg>
        </div>
        <div class="progress-steps" id="progress-dots" aria-label="Progreso de ensamblaje"></div>
      </section>

      <!-- Columna 2: VIDEOLLAMADA (compa√±eros) -->
      <section class="panel" aria-label="Ventanas de videollamada">
        <div class="call-grid">
          <div id="avatar-verde" class="call-window" aria-label="Avatar Verde">
            <div class="bubble">üôÇ</div>
            <div class="storm" aria-hidden="true">‚õàÔ∏è</div>
            <div class="name-tag">Avatar Verde</div>
            <div aria-hidden="true" style="font-size:44px">üü¢</div>
          </div>
          <div id="avatar-rojo" class="call-window" aria-label="Avatar Rojo">
            <div class="bubble">üôÇ</div>
            <div class="storm" aria-hidden="true">‚õàÔ∏è</div>
            <div class="name-tag">Avatar Rojo</div>
            <div aria-hidden="true" style="font-size:44px">üî¥</div>
          </div>
          <div id="avatar-capitan" class="call-window" aria-label="Capit√°n (t√∫)">
            <div class="bubble">ü´°</div>
            <div class="name-tag">T√∫ ‚Äî Capit√°n</div>
            <div aria-hidden="true" style="font-size:44px">üßë‚Äç‚úàÔ∏è</div>
          </div>
          <div id="avatar-chat" class="call-window" aria-label="Chat de equipo">
            <div class="name-tag">Chat</div>
            <div aria-hidden="true" style="font-size:26px">üí¨</div>
          </div>
        </div>
      </section>

      <!-- Columna 3: PLANO + HERRAMIENTAS + CHAT -->
      <aside class="side">
        <section class="panel plan" aria-label="Plano de Ensamblaje">
          <h3 style="margin:0 0 8px 0">Plano de Ensamblaje</h3>
          <div id="plan-steps" class="plan-steps"></div>
          <div id="plan-block" class="plan-overlay-block" aria-hidden="true">
            <div>
              <p>üìµ El chat distra√≠do est√° tapando el plano...</p>
              <p><strong>Arrastra el üì£ Meg√°fono del Capit√°n al Chat</strong> para retomar el foco.</p>
            </div>
          </div>
        </section>

        <section class="panel" aria-label="Men√∫ de herramientas">
          <h3 style="margin:0 0 8px 0">Herramientas</h3>
          <div class="tools">
            <!-- √çconos grandes y claros -->
            <div id="tool-turnos" class="tool" draggable="true" role="button" aria-label="üìã Plano de Turnos" title="üìã Plano de Turnos">üìã</div>
            <div id="tool-animo" class="tool" draggable="true" role="button" aria-label="üëç Emoji de √Ånimo" title="üëç Emoji de √Ånimo">üëç</div>
            <div id="tool-megafono" class="tool" draggable="true" role="button" aria-label="üì£ Meg√°fono del Capit√°n" title="üì£ Meg√°fono del Capit√°n">üì£</div>
          </div>
          <p style="font-size:12px; color:#bcd" aria-hidden="true">Consejo: Arrastra la herramienta hacia el avatar o al chat cuando ocurra una crisis.</p>
        </section>

        <section class="panel chat" aria-label="Panel de chat">
          <div class="chat-messages" id="chat-log" aria-live="polite"></div>
          <div id="chat-flood" class="chat-flood">
            <div>
              <p>üí• Mensajes irrelevantes bloquean la vista.</p>
              <p><strong>Usa el üì£ Meg√°fono del Capit√°n en el Chat</strong>.</p>
            </div>
          </div>
        </section>
      </aside>

    </div>
  </section>

  <!-- ============================
       PANTALLA 3: RESULTADOS
       ============================ -->
  <section id="screen-result" class="hidden" aria-label="Resultados de la misi√≥n">
    <div class="result-card">
      <h2 id="result-title">Resultado</h2>
      <p id="result-sub">‚Äî</p>
      <div class="metrics">
        <div class="metric"><strong>Veces que respetaste el turno:</strong> <span id="m-turno">0</span></div>
        <div class="metric"><strong>Intervenciones exitosas:</strong> <span id="m-interv">0</span></div>
        <div class="metric"><strong>Compa√±eros animados:</strong> <span id="m-animo">0</span></div>
        <div class="metric"><strong>Tiempo restante:</strong> <span id="m-time">0s</span></div>
      </div>
      <p><strong>Rango:</strong> <span id="rank-stars">‚≠ê</span></p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:10px">
        <button id="btn-play-again">Jugar de nuevo</button>
        <button id="btn-creditos-final" class="btn-ghost">Cr√©ditos</button>
      </div>
    </div>
  </section>

</div>

<script>
/* ===========================================================
   CONSTRUCTORES DE LA GALAXIA ‚Äî L√ìGICA DEL JUEGO (JS PURO)
   C√≥digo comentado en espa√±ol para facilitar comprensi√≥n.
   =========================================================== */

/* ----------------------------
   UTILIDADES DE AUDIO (WebAudio)
   - Peque√±os sonidos generados por osciladores (sin archivos externos)
   ---------------------------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audio = new AudioCtx();
let soundOn = true;

function beep(type="sine", freq=880, dur=0.12, gain=0.05){
  if(!soundOn) return;
  const t0 = audio.currentTime;
  const osc = audio.createOscillator();
  const g = audio.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  g.gain.value = gain;
  osc.connect(g).connect(audio.destination);
  osc.start(t0);
  osc.stop(t0 + dur);
}

function chordSuccess(){
  if(!soundOn) return;
  // acorde simple mayor
  beep("triangle", 660, .12, .06);
  setTimeout(()=>beep("triangle", 880, .12, .06), 60);
  setTimeout(()=>beep("triangle", 990, .12, .05), 120);
}
function gearClick(){ beep("square", 700, .08, .07) }          // "clic de engranaje"
function powerUpFriend(){ beep("sine", 520, .15, .07); setTimeout(()=>beep("sine", 780, .15, .06), 120) } // "power-up de amistad"
function achievement(){ chordSuccess() }                        // sonido de logro
function penalty(){ beep("sawtooth", 180, .22, .08) }           // penalizaci√≥n

/* ----------------------------
   ACCESIBILIDAD: SPEECH SYNTHESIS
   ---------------------------- */
const voice = window.speechSynthesis;
function speak(texto){
  // Evitar superposici√≥n de voces
  try{ voice.cancel() }catch(e){}
  const u = new SpeechSynthesisUtterance(texto);
  u.lang = "es-MX";
  u.rate = 1;
  u.pitch = 1;
  if(soundOn) voice.speak(u);
}

/* ----------------------------
   ESTADO GLOBAL DEL JUEGO
   ---------------------------- */
const GAME = {
  totalPieces: 6,
  currentStep: 1,
  placed: 0,
  timer: 180, // 3:00 minutos en segundos
  timerId: null,
  running: false,
  metrics: {
    respetoTurno: 0,
    intervenciones: 0,
    companerosAnimados: 0,
  },
  crisisActive: null, // {type, target, timeoutId}
  distractedTickId: null, // penalizaci√≥n peri√≥dica del chat distra√≠do
  order: [1,2,3,4,5,6],
  turnOrder: ["verde","rojo","capitan","verde","rojo","capitan"], // Qui√©n coloca cada pieza
};

/* ----------------------------
   ELEMENTOS DEL DOM (atajos)
   ---------------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const screenBriefing = $("#screen-briefing");
const screenGame = $("#screen-game");
const screenResult = $("#screen-result");
const timerEl = $("#timer");
const planStepsEl = $("#plan-steps");
const planBlock = $("#plan-block");
const progressDots = $("#progress-dots");
const chatLog = $("#chat-log");
const chatFlood = $("#chat-flood");

const avatarEl = {
  verde: $("#avatar-verde"),
  rojo: $("#avatar-rojo"),
  capitan: $("#avatar-capitan"),
  chat: $("#avatar-chat"),
};
const bubbles = {
  verde: avatarEl.verde.querySelector(".bubble"),
  rojo: avatarEl.rojo.querySelector(".bubble"),
  capitan: avatarEl.capitan.querySelector(".bubble"),
};
const storms = {
  verde: avatarEl.verde.querySelector(".storm"),
  rojo: avatarEl.rojo.querySelector(".storm"),
};

const tools = {
  turnos: $("#tool-turnos"),
  animo: $("#tool-animo"),
  megafono: $("#tool-megafono"),
};

const pieceEls = GAME.order.map(i => document.getElementById(`piece-${i}`));

/* ----------------------------
   INICIALIZACI√ìN DE UI
   ---------------------------- */
function formatTime(s){
  const m = Math.floor(s/60).toString().padStart(2,'0');
  const r = (s%60).toString().padStart(2,'0');
  return `${m}:${r}`;
}
function drawPlan(){
  // Pintar el orden de colocaci√≥n y resaltar el actual
  planStepsEl.innerHTML = "";
  GAME.order.forEach((n, idx)=>{
    const div = document.createElement("div");
    div.className = "plan-step";
    const who = GAME.turnOrder[idx];
    const name = who==="verde"?"Verde":(who==="rojo"?"Rojo":"Capit√°n");
    div.textContent = `Paso ${n} ‚Üí ${name}`;
    if(n === GAME.currentStep){
      div.style.outline = `2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')}`;
    }
    planStepsEl.appendChild(div);
  });
}
function drawProgressDots(){
  progressDots.innerHTML = "";
  GAME.order.forEach(n=>{
    const d = document.createElement("div");
    d.className = "step-dot" + (n<GAME.currentStep ? " done" : (n===GAME.currentStep?" current":""));
    progressDots.appendChild(d);
  });
}
function activatePieces(){
  pieceEls.forEach((el, idx)=>{
    const step = idx+1;
    el.classList.remove("placed","active");
    if(step < GAME.currentStep) el.classList.add("placed");
    else if(step === GAME.currentStep) el.classList.add("active");
  });
}

function resetChat(){
  chatLog.innerHTML = "";
  chatFlood.classList.remove("active");
  planBlock.classList.remove("active");
}

function postChat(msg){
  const p = document.createElement("div");
  p.textContent = `üí¨ ${msg}`;
  chatLog.prepend(p);
}

/* ----------------------------
   TIMER Y FIN DE PARTIDA
   ---------------------------- */
function startTimer(){
  clearInterval(GAME.timerId);
  GAME.timerId = setInterval(()=>{
    if(!GAME.running) return;
    GAME.timer--;
    timerEl.textContent = formatTime(GAME.timer);
    if(GAME.timer<=0){
      GAME.timer = 0;
      timerEl.textContent = '00:00';
      endGame(false);
    }
  }, 1000);
}
function changeTime(delta){
  GAME.timer = Math.max(0, GAME.timer + delta);
  timerEl.textContent = formatTime(GAME.timer);
  if(delta<0) penalty();
}

/* ----------------------------
   EVENTOS ALEATORIOS (CRISIS)
   Tipos:
   - rushTurn (Crisis del Turno Apresurado)
   - frustration (Crisis del Error y la Frustraci√≥n)
   - chatNoise (Crisis del Chat Distra√≠do)
   ---------------------------- */
function scheduleRandomEvent(){
  if(!GAME.running) return;
  // Programar un evento entre 7 y 14 segundos
  const delay = 7000 + Math.random()*7000;
  setTimeout(triggerRandomEvent, delay);
}

function triggerRandomEvent(){
  if(!GAME.running) return;
  // No generar si ya hay una crisis activa
  if(GAME.crisisActive){ scheduleRandomEvent(); return; }

  // Elegir evento, ponderando un poco el chat para variedad
  const types = ["rushTurn","frustration","chatNoise","rushTurn"];
  const type = types[Math.floor(Math.random()*types.length)];

  if(type==="rushTurn"){
    // Avatar equivocado intenta colocar pieza (que NO sea el del turno actual)
    const current = GAME.turnOrder[GAME.currentStep-1];
    const others = ["verde","rojo","capitan"].filter(n=>n!==current);
    const target = others[Math.floor(Math.random()*others.length)];
    crisisRushTurn(target);
  }else if(type==="frustration"){
    const current = GAME.turnOrder[GAME.currentStep-1];
    // s√≥lo tiene sentido si el que toca no es el capit√°n (para fomentar apoyo)
    const target = (current==="capitan") ? (Math.random()<.5?"verde":"rojo") : current;
    crisisFrustration(target);
  }else{
    crisisChatNoise();
  }
}

function clearCrisis(){
  if(GAME.crisisActive?.timeoutId) clearTimeout(GAME.crisisActive.timeoutId);
  GAME.crisisActive = null;
  // limpiar marcas visuales
  Object.values(avatarEl).forEach(a=>a.classList.remove("rush"));
  Object.values(storms).forEach(s=>s.classList.remove("active"));
  chatFlood.classList.remove("active");
  planBlock.classList.remove("active");
  if(GAME.distractedTickId){ clearInterval(GAME.distractedTickId); GAME.distractedTickId = null; }
}

function crisisRushTurn(target){
  GAME.crisisActive = { type:"rushTurn", target };
  avatarEl[target].classList.add("rush");
  postChat(`‚ö†Ô∏è ${capitalize(target)} intenta colocar una pieza fuera de turno.`);
  speak("Atenci√≥n. Un compa√±ero intenta saltarse el turno. Usa el Plano de Turnos.");
  // Si no se corrige en 5s, coloca mal la pieza: penalizaci√≥n -10s
  const timeoutId = setTimeout(()=>{
    if(GAME.crisisActive && GAME.crisisActive.type==="rushTurn"){
      postChat("‚õî La gr√∫a retira la pieza mal colocada. -10s");
      changeTime(-10);
      clearCrisis();
      scheduleRandomEvent();
    }
  }, 5000);
  GAME.crisisActive.timeoutId = timeoutId;
}

function crisisFrustration(target){
  GAME.crisisActive = { type:"frustration", target };
  storms[target]?.classList.add("active");
  bubbles[target].textContent = "üòû";
  postChat(`‚ö†Ô∏è ${capitalize(target)} se desanim√≥ tras un error.`);
  speak("√Ånimo al compa√±ero. Usa el pulgar de √°nimo.");
  // Sin l√≠mite de tiempo: el progreso se estanca si su turno est√° activo
}

function crisisChatNoise(){
  GAME.crisisActive = { type:"chatNoise", target:"chat" };
  chatFlood.classList.add("active");
  planBlock.classList.add("active");
  postChat("üì¢ El chat se llen√≥ de mensajes irrelevantes y tapa el plano.");
  speak("Lidera con el meg√°fono del capit√°n para enfocar el chat.");
  // Penalizaci√≥n peri√≥dica si no se atiende: -5s cada 7s
  GAME.distractedTickId = setInterval(()=>{
    if(GAME.crisisActive?.type==="chatNoise"){
      postChat("‚è≥ Perdemos tiempo por distracciones. -5s");
      changeTime(-5);
    }
  }, 7000);
}

/* ----------------------------
   INTERACCI√ìN PRINCIPAL: COLOCAR PIEZAS
   - Avanza autom√°ticamente cada ~4s si:
     a) No hay crisis incompatible
     b) El turno corresponde
   ---------------------------- */
let placeTickId = null;
function startPlacingLoop(){
  clearInterval(placeTickId);
  placeTickId = setInterval(()=>{
    if(!GAME.running) return;
    // Si la crisis es chatNoise, a√∫n se puede colocar, pero con distracci√≥n (dejamos al jugador elegir resolver)
    // Si la crisis es frustration y es el turno del avatar afectado, NO avanza
    if(GAME.crisisActive?.type==="frustration"){
      const target = GAME.crisisActive.target;
      const who = GAME.turnOrder[GAME.currentStep-1];
      if(target === who){
        // Progreso detenido
        return;
      }
    }
    // Si la crisis es rushTurn, el avatar equivocado est√° interrumpiendo; a√∫n as√≠ impedimos hasta resolver o penalizar
    if(GAME.crisisActive?.type==="rushTurn") return;

    // Colocar pieza tras un intervalo (simulaci√≥n de trabajo en equipo)
    placeCurrentPiece();
  }, 4000);
}

function placeCurrentPiece(){
  if(GAME.currentStep > GAME.totalPieces) return;
  const idx = GAME.currentStep - 1;
  const el = pieceEls[idx];
  // Mostrar animaci√≥n de ‚Äúcolocar‚Äù
  el.classList.add("placed");
  GAME.placed++;
  GAME.currentStep++;
  drawPlan(); drawProgressDots(); activatePieces();

  // Si completamos todo ‚Üí victoria
  if(GAME.currentStep > GAME.totalPieces){
    endGame(true);
    return;
  }
}

/* ----------------------------
   DRAG & DROP DE HERRAMIENTAS
   - Arrastrar üìã al avatar en "rushTurn"
   - Arrastrar üëç al avatar en "frustration"
   - Arrastrar üì£ al Chat en "chatNoise"
   ---------------------------- */
Object.values(tools).forEach(t=>{
  t.addEventListener("dragstart", ev=>{
    ev.dataTransfer.setData("text/plain", ev.target.id);
  });
});

Object.values(avatarEl).forEach(win=>{
  win.addEventListener("dragover", e=> e.preventDefault());
  win.addEventListener("drop", onDropTarget);
});

function onDropTarget(e){
  e.preventDefault();
  const toolId = e.dataTransfer.getData("text/plain");
  const targetId = e.currentTarget.id;

  // Normalizar destino
  const target = targetId.includes("verde") ? "verde" :
                 targetId.includes("rojo")  ? "rojo"  :
                 targetId.includes("capitan") ? "capitan" :
                 "chat";

  // Verificar crisis activa
  if(!GAME.crisisActive){
    postChat("‚ÑπÔ∏è No hay crisis que atender ahora mismo.");
    return;
  }

  const c = GAME.crisisActive;

  // 1) Rush Turn ‚Üí herramienta: turnos + avatar que interrumpe
  if(c.type==="rushTurn"){
    if(toolId==="tool-turnos" && (target===c.target)){
      successRushTurn(target);
    }else{
      // Error: ignoramos pero retroalimentamos
      postChat("‚ùå Esa no es la herramienta correcta para el problema.");
      penalty();
      changeTime(-3);
    }
  }

  // 2) Frustration ‚Üí herramienta: √°nimo + sobre el avatar desanimado
  else if(c.type==="frustration"){
    if(toolId==="tool-animo" && target===c.target){
      successFrustration(target);
    }else{
      postChat("‚ùå Esa acci√≥n no anima al compa√±ero.");
      penalty();
      changeTime(-3);
    }
  }

  // 3) ChatNoise ‚Üí herramienta: meg√°fono + sobre chat
  else if(c.type==="chatNoise"){
    if(toolId==="tool-megafono" && target==="chat"){
      successChatNoise();
    }else{
      postChat("‚ùå El meg√°fono se usa directamente en el chat distra√≠do.");
      penalty();
      changeTime(-3);
    }
  }
}

function successRushTurn(target){
  gearClick();
  GAME.metrics.respetoTurno++;
  GAME.metrics.intervenciones++;
  postChat("‚úÖ Se respet√≥ el turno. ¬°Avancemos!");
  speak("¬°Sigamos el orden para que todo encaje!");
  tipOnScreen("¬°Uno por uno es m√°s veloz, si escuchamos la misma voz!");
  clearCrisis();
  scheduleRandomEvent();
}

function successFrustration(target){
  powerUpFriend();
  GAME.metrics.companerosAnimados++;
  GAME.metrics.intervenciones++;
  bubbles[target].textContent = "üôÇ";
  postChat("‚úÖ √Ånimo recuperado. ¬°Buen trabajo en equipo!");
  speak("¬°No te preocupes, int√©ntalo de nuevo!");
  tipOnScreen("¬°Un equipo que se apoya, cualquier error lo arrolla!");
  clearCrisis();
  scheduleRandomEvent();
}

function successChatNoise(){
  achievement();
  GAME.metrics.intervenciones++;
  postChat("‚úÖ El chat volvi√≥ a enfocarse en la misi√≥n.");
  speak("¬°Excelente liderazgo, Capit√°n!");
  tipOnScreen("¬°Una charla a la vez, para lograrlo con rapidez!");
  clearCrisis();
  scheduleRandomEvent();
}

/* ----------------------------
   CONSEJOS EN PANTALLA (feedback textual breve)
   ---------------------------- */
let tipTimeout = null;
function tipOnScreen(text){
  const el = document.createElement("div");
  el.setAttribute("role","status");
  el.style.position="fixed";
  el.style.left="50%"; el.style.top="14px"; el.style.transform="translateX(-50%)";
  el.style.background="#0b1326";
  el.style.border="1px solid rgba(255,255,255,.15)";
  el.style.padding="8px 12px";
  el.style.borderRadius="12px";
  el.style.boxShadow="var(--shadow)";
  el.style.zIndex=9999;
  el.style.pointerEvents="none";
  el.textContent = text;
  document.body.appendChild(el);
  clearTimeout(tipTimeout);
  tipTimeout = setTimeout(()=> el.remove(), 2200);
}

/* ----------------------------
   CONTROLES DE FLUJO DE PANTALLAS
   ---------------------------- */
function gotoBriefing(){
  screenBriefing.classList.remove("hidden");
  screenGame.classList.add("hidden");
  screenResult.classList.add("hidden");
}
function gotoGame(){
  screenBriefing.classList.add("hidden");
  screenGame.classList.remove("hidden");
  screenResult.classList.add("hidden");
}
function gotoResult(){
  screenBriefing.classList.add("hidden");
  screenGame.classList.add("hidden");
  screenResult.classList.remove("hidden");
}

/* ----------------------------
   INICIO Y REINICIO DE PARTIDA
   ---------------------------- */
function newGame(){
  // Reiniciar estado
  GAME.currentStep = 1;
  GAME.placed = 0;
  GAME.timer = 180;
  GAME.metrics = { respetoTurno:0, intervenciones:0, companerosAnimados:0 };
  GAME.running = true;
  clearCrisis();
  resetChat();
  drawPlan(); drawProgressDots(); activatePieces();
  timerEl.textContent = formatTime(GAME.timer);
  startTimer();
  startPlacingLoop();
  scheduleRandomEvent();
}

function endGame(victory){
  GAME.running = false;
  clearInterval(GAME.timerId);
  clearInterval(placeTickId);
  clearCrisis();

  // Animaci√≥n en la nave (√©xito o fallo)
  const shipSvg = document.querySelector(".ship-svg");
  shipSvg.classList.remove("launch","fail");
  void shipSvg.offsetWidth; // reflow
  shipSvg.classList.add(victory ? "launch":"fail");

  // Calcular estrellas (1-3) seg√∫n tiempo restante y cooperaci√≥n
  const t = GAME.timer; // segundos
  const coop = GAME.metrics.intervenciones; // colaboraciones
  let stars = 1;
  if(victory && (t>=60 || coop>=3)) stars = 2;
  if(victory && (t>=100 || coop>=5)) stars = 3;

  // Rellenar pantalla de resultados
  $("#result-title").textContent = victory ? "¬°Victoria!" : "Misi√≥n Fallida";
  $("#result-sub").textContent = victory
    ? "La nave est√° completa. ¬°Listos para despegar!"
    : "Se acab√≥ el tiempo con la nave incompleta. ¬°La pr√≥xima saldr√° mejor!";
  $("#m-turno").textContent = GAME.metrics.respetoTurno;
  $("#m-interv").textContent = GAME.metrics.intervenciones;
  $("#m-animo").textContent = GAME.metrics.companerosAnimados;
  $("#m-time").textContent = `${t}s`;
  $("#rank-stars").textContent = "‚≠ê".repeat(stars);

  // Mostrar resultados tras un peque√±o delay para que se vea la animaci√≥n
  setTimeout(()=> gotoResult(), 1100);
}

/* ----------------------------
   BOTONES Y ACCIONES DE UI
   ---------------------------- */
$("#btn-start").addEventListener("click", ()=>{
  // desbloquear audio en primer gesto
  if(audio.state==="suspended"){ audio.resume(); }
  gotoGame();
  newGame();
  speak("¬°Tripulaci√≥n, iniciamos misi√≥n! Recuerden: plano, escucha y √°nimo. Tres minutos en el reloj.");
});
$("#btn-restart").addEventListener("click", ()=>{ gotoGame(); newGame(); });
$("#btn-play-again").addEventListener("click", ()=>{ gotoGame(); newGame(); });

$("#btn-mute").addEventListener("click", (e)=>{
  soundOn = !soundOn;
  e.currentTarget.setAttribute("aria-pressed", String(!soundOn));
  e.currentTarget.textContent = soundOn ? "üîà Sonido" : "üîá Silencio";
});

$("#btn-briefing-voz").addEventListener("click", ()=>{
  speak("Cadetes, hoy construir√°n una nave estelar respetando la netiqueta. Regla del plano: sigan el orden indicado. Regla de la escucha: un turno de habla a la vez. Regla del √°nimo: apoyen a sus compa√±eros. Tienen tres minutos. Cada error cuesta tiempo. ¬°Conf√≠o en ustedes!");
});

function showCreditos(){
  alert("Cr√©ditos:\n‚Ä¢ Dise√±o pedag√≥gico y juego: Gnius Club\n‚Ä¢ Desarrollo: HTML5, CSS, JS puro\n‚Ä¢ Accesibilidad: SpeechSynthesis + alto contraste\n‚Ä¢ Sonidos: WebAudio API (osciladores)");
}
$("#btn-creditos").addEventListener("click", showCreditos);
$("#btn-creditos-final").addEventListener("click", showCreditos);

/* ----------------------------
   AYUDAS VARIAS
   ---------------------------- */
function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1) }

/* ----------------------------
   ARRANQUE VISUAL DEL BRIEFING
   (texto animado simple)
   ---------------------------- */
(function typeIntro(){
  const txt = 'Jefe de Misi√≥n: ‚ÄúCadetes, construyan su nave siguiendo tres reglas: el Plano, la Escucha y el √Ånimo. ¬°Adelante!‚Äù';
  const el = document.getElementById("briefing-texto");
  let i=0;
  const tick = ()=> {
    if(i<=txt.length){ el.textContent = txt.slice(0,i++); requestAnimationFrame(tick); }
  };
  tick();
})();

/* ----------------------------
   ACTIVACI√ìN INICIAL DE PANELES
   ---------------------------- */
drawPlan(); drawProgressDots(); activatePieces();

/* ===========================================================
   FIN DEL SCRIPT
   =========================================================== */
</script>
</body>
</html>
